easyblock = 'PythonBundle'

name = 'Optax'
version = '0.1.7'

homepage = 'https://github.com/deepmind/optax'
description = """Optax is a gradient processing and optimization library for JAX."""

toolchain = {'name': 'foss', 'version': '2022a'}

dependencies = [
    ('Python', '3.10.4'),
    ('SciPy-bundle', '2022.05'),
    ('jax', '0.3.25'),
    ('typing-extensions', '4.3.0'),
]

builddependencies = [
    ('CMake', '3.23.1'),  # required for installing dm-tree
    ('pytest-xdist', '2.5.0'),
]

use_pip = True

exts_list = [
    ('toolz', '0.12.0', {
        'checksums': ['88c570861c440ee3f2f6037c4654613228ff40c93a6c25e0eba70d17282c6194'],
    }),
    ('jmp', '0.0.4', {
        'checksums': ['5dfeb0fd7c7a9f72a70fff0aab9d0cbfae32a809c02f4037ff3485ceb33e1730'],
    }),
    ('dm-haiku', '0.0.9', {
        'modulename': 'haiku',
        'source_urls': ['https://github.com/deepmind/dm-haiku/archive/refs/tags/'],
        'sources': [{'download_filename': 'v%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['d550f07f5891ede30ada5faafde98f549ed1b8ceadb7a601cca3d81db7d82414'],
    }),
    ('dm-tree', '0.1.8', {
        'modulename': 'tree',
        'checksums': ['0fcaabbb14e7980377439e7140bd05552739ca5e515ecb3119f234acee4b9430'],
    }),
    ('chex', '0.1.6', {
        'checksums': ['adb5d2352b5f0d248ccf594be1b1bf9ee7a2bee2a57f0eac78547538d479b0e7'],
    }),
    ('optax', version, {
        'checksums': ['6a5a848bc5e55e619b187c749fdddc4a5443ea14be85cc769f995779865c110d'],
        # ignore equivalence_test.py which imports flax, which depends on optax
        'runtest': 'python -m pytest -n %(parallel)s --pyargs --ignore-glob="**/equivalence_test.py" optax',
    }),
]

sanity_pip_check = True

sanity_check_commands = ["python -c 'from optax import GradientTransformation'"]

moduleclass = 'lib'
